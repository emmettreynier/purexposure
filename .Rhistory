years_check <- 1990:2015
}
} else {
years_check <- years
}
if (counties == "all") {
counties_check <- purexposure::county_codes$county_code
} else {
counties_check <- find_counties(counties)
}
years_check <- years_check %in% unique_years
if (!all(years_check)) {
stop(paste0("The years argument specifies years not present in the given ",
"raw_pur_df data frame."))
}
counties_check <- counties_check %in% unique_counties
if (!all(counties_check)) {
stop(paste0("The counties argument specifies counties not present in the ",
"given raw_pur_df data frame."))
}
raw_df <- raw_pur_df
}
df <- raw_df %>%
dplyr::mutate(township_pad = stringr::str_pad(raw_df$township, 2, "left", pad = "0"),
range = stringr::str_pad(raw_df$range, 2, "left", pad = "0"),
section = stringr::str_pad(raw_df$section, 2, "left", pad = "0"),
MTRS = as.character(paste0(base_ln_mer, township_pad, tship_dir,
range, range_dir, section)),
township = as.character(paste0(base_ln_mer, township_pad, tship_dir)),
MTR = as.character(paste0(township, range, range_dir))) %>%
dplyr::select(chem_code, lbs_chm_used, MTRS, MTR, county_cd, applic_dt,
aer_gnd_ind, use_no, acre_treated, unit_treated, prodno) %>%
dplyr::mutate(unit_treated = as.factor(unit_treated)) %>%
dplyr::filter(!MTRS %in% c(".0..0..0.", ".00.00.00", "NANANANANANA"),
unit_treated %in% c("A", "S")) %>%
dplyr::mutate(acre_treated = as.numeric(acre_treated),
lbs_chm_used = as.numeric(lbs_chm_used),
acre_treated = ifelse(unit_treated == "S",
acre_treated * 2.29568e-5,
acre_treated),
unit_treated = "A", # going to remove this later - all acres
lbs_per_acre = lbs_chm_used/acre_treated,
chem_code = as.integer(chem_code))
calc_max <- df %>%
dplyr::mutate(year = as.character(lubridate::year(lubridate::ymd(applic_dt)))) %>%
dplyr::group_by(chem_code, year) %>%
dplyr::summarize(mean = mean(lbs_per_acre, na.rm = TRUE),
sd = sd(lbs_per_acre, na.rm = TRUE)) %>%
dplyr::mutate(calc_max = mean + 2*sd)
calc_max
if (!"all" %in% chemicals) {
years_chemicals <- expand.grid(year = years, chemicals = chemicals) %>%
dplyr::group_by(year) %>%
tidyr::nest() %>%
dplyr::mutate(chemicals = purrr::map(data, tibble_to_vector))
chem_df <- purrr::map2_dfr(years_chemicals$year, years_chemicals$chemicals,
find_chemical_codes) %>% unique()
df <- df %>%
dplyr::filter(chem_code %in% chem_df$chem_code) %>%
dplyr::left_join(chem_df, by = "chem_code") %>%
dplyr::select(-chemical) %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
# chemicals
if (nrow(df) == 0) {
if (length(chemicals) == 1) {
chem_message <- paste0(chemicals)
} else if (length(chemicals) == 2) {
chem_message <- paste0(chemicals[1], " or ", chemicals[2])
} else if (length(chemicals) > 2 & length(chemicals) < 11) {
chems_vec <- chemicals[1:length(chemicals)-1]
chems_vec <- paste(chems_vec, collapse = ", ")
chem_message <- paste0(chems_vec, ", or ", chemicals[length(chemicals)])
} else if (length(chemicals) >= 11) {
chem_message <- "these chemicals"
}
# years
if (length(years) == 1) {
year_message <- years
} else if (length(years) == 2) {
year_message <- paste0(years[1], " or ", years[2])
} else if (length(years) > 1) {
years_list <- split(years, cumsum(c(1, diff(years) != 1)))
if (length(years_list) == 1) {
year_message <- paste0(years[1], " through ", years[length(years)])
} else {
years_vec <- years[1:length(years)-1]
years_vec <- paste(years_vec, collapse = ", ")
year_message <- paste0(years_vec, ", or ", years[length(years)])
}
}
# counties
names_clean <- find_counties(counties, return = "names")
if (length(names_clean) == 1) {
county_message <- paste0(names_clean, " county.")
} else if (length(names_clean) == 2) {
county_message <- paste0(names_clean[1], " or ", names_clean[2],
" county.")
} else if (length(names_clean) > 2) {
counties_vec <- names_clean[1:length(names_clean)-1]
counties_vec <- paste(counties_vec, collapse = ", ")
county_message <- paste0(counties_vec, ", or ",
names_clean[length(names_clean)], " county.")
}
stop(paste0("There weren't any pesticides containing ", chem_message,
" applied in ", year_message, " in ", county_message))
}
} else {
chem_df <- purexposure::chemical_list
out_chem_list <- list()
for (i in 1:length(years)) {
chem_year <- chem_df[[as.character(years[i])]]
chem_year <- chem_year %>% dplyr::mutate(year = as.character(years[i]))
out_chem_list[[i]] <- chem_year
}
out_chem_df <- dplyr::bind_rows(out_chem_list)
df <- df %>% dplyr::mutate(applic_dt = lubridate::mdy(applic_dt),
year = lubridate::year(applic_dt),
year = as.character(year)) %>%
dplyr::left_join(out_chem_df, by = c("chem_code", "year"))
}
df
df <- raw_df %>%
dplyr::mutate(township_pad = stringr::str_pad(raw_df$township, 2, "left", pad = "0"),
range = stringr::str_pad(raw_df$range, 2, "left", pad = "0"),
section = stringr::str_pad(raw_df$section, 2, "left", pad = "0"),
MTRS = as.character(paste0(base_ln_mer, township_pad, tship_dir,
range, range_dir, section)),
township = as.character(paste0(base_ln_mer, township_pad, tship_dir)),
MTR = as.character(paste0(township, range, range_dir))) %>%
dplyr::select(chem_code, lbs_chm_used, MTRS, MTR, county_cd, applic_dt,
aer_gnd_ind, use_no, acre_treated, unit_treated, prodno) %>%
dplyr::mutate(unit_treated = as.factor(unit_treated)) %>%
dplyr::filter(!MTRS %in% c(".0..0..0.", ".00.00.00", "NANANANANANA"),
unit_treated %in% c("A", "S")) %>%
dplyr::mutate(acre_treated = as.numeric(acre_treated),
lbs_chm_used = as.numeric(lbs_chm_used),
acre_treated = ifelse(unit_treated == "S",
acre_treated * 2.29568e-5,
acre_treated),
unit_treated = "A", # going to remove this later - all acres
lbs_per_acre = lbs_chm_used/acre_treated,
chem_code = as.integer(chem_code))
df %>%
dplyr::filter(chem_code %in% chem_df$chem_code) %>%
dplyr::left_join(chem_df, by = "chem_code") %>%
dplyr::select(-chemical) %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
df %>%
dplyr::filter(chem_code %in% chem_df$chem_code)
df %>% dplyr::mutate(applic_dt = lubridate::ymd(applic_dt),
year = lubridate::year(applic_dt),
year = as.character(year)) %>%
dplyr::left_join(out_chem_df, by = c("chem_code", "year"))
one <- pull_raw_pur(1990, "fresno")
two <- pull_raw_pur(2015, "fresno")
three <- pull_raw_pur(1990, "yolo")
four <- pull_raw_pur(2015, "yolo")
my_list <- list(one, two, three, four)
map(my_list, function(x) unique(x$applic_dt))
purrr::map(my_list, function(x) unique(x$applic_dt))
purrr::map(my_list, function(x) head(x$applic_dt))
if (is.null(raw_pur_df)) {
raw_df <- pull_raw_pur(years = years, counties = counties, verbose = verbose,
download_progress = download_progress)
} else {
check <- colnames(raw_pur_df == c("use_no", "prodno", "chem_code",
"prodchem_pct", "lbs_chm_used",
"lbs_prd_used", "amt_prd_used",
"unit_of_meas", "acre_planted",
"unit_planted", "acre_treated",
"unit_treated", "applic_cnt", "applic_dt",
"applic_time", "county_cd", "base_ln_mer",
"township", "tship_dir", "range",
"range_dir", "section", "site_loc_id",
"grower_id", "license_no", "planting_seq",
"aer_gnd_ind", "site_code", "qualify_cd",
"batch_no", "document_no", "summary_cd",
"record_id"))
if (!check) {
stop(paste0("The raw_pur_df data frame should be returned from ",
"pull_raw_pur() and should have 33 columns."))
}
unique_years <- raw_pur_df %>%
dplyr::mutate(year = lubridate::year(lubridate::ymd(applic_dt))) %>%
dplyr::select(year) %>%
unique() %>%
tibble_to_vector()
unique_counties <- raw_pur_df %>%
dplyr::select(county_cd) %>%
unique() %>%
tibble_to_vector() %>%
find_counties(return = "codes")
if (is.character(years)) {
if (years == "all") {
years_check <- 1990:2015
}
} else {
years_check <- years
}
if (counties == "all") {
counties_check <- purexposure::county_codes$county_code
} else {
counties_check <- find_counties(counties)
}
years_check <- years_check %in% unique_years
if (!all(years_check)) {
stop(paste0("The years argument specifies years not present in the given ",
"raw_pur_df data frame."))
}
counties_check <- counties_check %in% unique_counties
if (!all(counties_check)) {
stop(paste0("The counties argument specifies counties not present in the ",
"given raw_pur_df data frame."))
}
raw_df <- raw_pur_df
}
df <- raw_df %>%
dplyr::mutate(township_pad = stringr::str_pad(raw_df$township, 2, "left", pad = "0"),
range = stringr::str_pad(raw_df$range, 2, "left", pad = "0"),
section = stringr::str_pad(raw_df$section, 2, "left", pad = "0"),
MTRS = as.character(paste0(base_ln_mer, township_pad, tship_dir,
range, range_dir, section)),
township = as.character(paste0(base_ln_mer, township_pad, tship_dir)),
MTR = as.character(paste0(township, range, range_dir))) %>%
dplyr::select(chem_code, lbs_chm_used, MTRS, MTR, county_cd, applic_dt,
aer_gnd_ind, use_no, acre_treated, unit_treated, prodno) %>%
dplyr::mutate(unit_treated = as.factor(unit_treated)) %>%
dplyr::filter(!MTRS %in% c(".0..0..0.", ".00.00.00", "NANANANANANA"),
unit_treated %in% c("A", "S")) %>%
dplyr::mutate(acre_treated = as.numeric(acre_treated),
lbs_chm_used = as.numeric(lbs_chm_used),
acre_treated = ifelse(unit_treated == "S",
acre_treated * 2.29568e-5,
acre_treated),
unit_treated = "A", # going to remove this later - all acres
lbs_per_acre = lbs_chm_used/acre_treated,
chem_code = as.integer(chem_code))
head(df)
calc_max <- df %>%
dplyr::mutate(year = as.character(lubridate::year(lubridate::ymd(applic_dt)))) %>%
dplyr::group_by(chem_code, year) %>%
dplyr::summarize(mean = mean(lbs_per_acre, na.rm = TRUE),
sd = sd(lbs_per_acre, na.rm = TRUE)) %>%
dplyr::mutate(calc_max = mean + 2*sd)
calc_max
if (!"all" %in% chemicals) {
years_chemicals <- expand.grid(year = years, chemicals = chemicals) %>%
dplyr::group_by(year) %>%
tidyr::nest() %>%
dplyr::mutate(chemicals = purrr::map(data, tibble_to_vector))
chem_df <- purrr::map2_dfr(years_chemicals$year, years_chemicals$chemicals,
find_chemical_codes) %>% unique()
df <- df %>%
dplyr::filter(chem_code %in% chem_df$chem_code) %>%
dplyr::left_join(chem_df, by = "chem_code") %>%
dplyr::select(-chemical) %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
# chemicals
if (nrow(df) == 0) {
if (length(chemicals) == 1) {
chem_message <- paste0(chemicals)
} else if (length(chemicals) == 2) {
chem_message <- paste0(chemicals[1], " or ", chemicals[2])
} else if (length(chemicals) > 2 & length(chemicals) < 11) {
chems_vec <- chemicals[1:length(chemicals)-1]
chems_vec <- paste(chems_vec, collapse = ", ")
chem_message <- paste0(chems_vec, ", or ", chemicals[length(chemicals)])
} else if (length(chemicals) >= 11) {
chem_message <- "these chemicals"
}
# years
if (length(years) == 1) {
year_message <- years
} else if (length(years) == 2) {
year_message <- paste0(years[1], " or ", years[2])
} else if (length(years) > 1) {
years_list <- split(years, cumsum(c(1, diff(years) != 1)))
if (length(years_list) == 1) {
year_message <- paste0(years[1], " through ", years[length(years)])
} else {
years_vec <- years[1:length(years)-1]
years_vec <- paste(years_vec, collapse = ", ")
year_message <- paste0(years_vec, ", or ", years[length(years)])
}
}
# counties
names_clean <- find_counties(counties, return = "names")
if (length(names_clean) == 1) {
county_message <- paste0(names_clean, " county.")
} else if (length(names_clean) == 2) {
county_message <- paste0(names_clean[1], " or ", names_clean[2],
" county.")
} else if (length(names_clean) > 2) {
counties_vec <- names_clean[1:length(names_clean)-1]
counties_vec <- paste(counties_vec, collapse = ", ")
county_message <- paste0(counties_vec, ", or ",
names_clean[length(names_clean)], " county.")
}
stop(paste0("There weren't any pesticides containing ", chem_message,
" applied in ", year_message, " in ", county_message))
}
} else {
chem_df <- purexposure::chemical_list
out_chem_list <- list()
for (i in 1:length(years)) {
chem_year <- chem_df[[as.character(years[i])]]
chem_year <- chem_year %>% dplyr::mutate(year = as.character(years[i]))
out_chem_list[[i]] <- chem_year
}
out_chem_df <- dplyr::bind_rows(out_chem_list)
df <- df %>% dplyr::mutate(applic_dt = lubridate::ymd(applic_dt),
year = lubridate::year(applic_dt),
year = as.character(year)) %>%
dplyr::left_join(out_chem_df, by = c("chem_code", "year"))
}
df
df <- df %>% dplyr::mutate(year = as.character(lubridate::ymd(applic_dt)))
df
head(year)
df <- df %>% dplyr::mutate(year = as.character(lubridate::year(applic_dt)))
head(df$year)
df2 <- calc_max %>%
dplyr::select(chem_code, year, calc_max) %>%
dplyr::right_join(df, by = c("chem_code", "year")) %>%
dplyr::mutate(outlier = ifelse((!is.na(calc_max) &
lbs_per_acre > calc_max), TRUE, FALSE),
lbs_chm_used = ifelse(lbs_per_acre > calc_max,
calc_max*acre_treated, lbs_chm_used)) %>%
dplyr::rename(county_code = county_cd) %>%
dplyr::ungroup()
df2
county <- purexposure::county_codes
out <- county %>%
dplyr::right_join(df2, by = "county_code") %>%
dplyr::mutate(use_no = paste0(use_no, "_", lubridate::year(applic_dt)),
kg_chm_used = lbs_chm_used/2.20562) %>%
dplyr::select(chem_code, chemname, kg_chm_used, MTRS, MTR, county_name,
county_code, applic_dt, aer_gnd_ind, use_no, outlier, prodno) %>%
dplyr::rename(section = MTRS,
township = MTR,
date = applic_dt,
aerial_ground = aer_gnd_ind) %>%
dplyr::arrange(date, county_name)
out
missing_sections <- grep("\\?", out$section, value = TRUE)
missing_townships <- grep("\\?", out$township, value = TRUE)
if (length(missing_sections) != 0) {
out <- out %>% dplyr::mutate(section = ifelse(section %in% missing_sections,
NA, section))
}
if (length(missing_townships) != 0) {
out <- out %>% dplyr::mutate(township = ifelse(township %in% missing_sections,
NA, township))
}
if (sum_application) {
section_townships <- out %>%
dplyr::select(section, township) %>%
unique()
if (sum == "all") {
if (unit == "section") {
if (aerial_ground) {
out <- help_sum_application(out, "all", "section", TRUE,
section_townships,
chem_code,
chemname, section, county_name, county_code,
date, aerial_ground)
} else {
out <- help_sum_application(out, "all", "section", FALSE,
section_townships,
chem_code,
chemname, section, county_name, county_code,
date)
}
} else if (unit == "township") {
if (aerial_ground) {
out <- help_sum_application(out, "all", "township", TRUE,
section_townships,
chem_code,
chemname, township, county_name, county_code,
date, aerial_ground)
} else {
out <- help_sum_application(out, "all", "township", FALSE,
section_townships,
chem_code,
chemname, township, county_name, county_code,
date)
}
}
} else if (sum == "chemical_class") {
## error handling for chemical_class df
if (!is.null(chemical_class) & !is.data.frame(chemical_class)) {
stop("The chemical_class argument should be a data frame.")
}
if (!is.null(chemical_class) & is.data.frame(chemical_class) &
!all(colnames(chemical_class) == c("chem_code", "chemname", "chemical_class"))) {
stop(writeLines(paste0("The data frame entered in the chemical class ",
"argument should have only three columns named chem_code, ",
"chemname, and chemical_class.")))
}
if (!is.null(chemical_class) & is.data.frame(chemical_class) &
all(colnames(chemical_class) == c("chem_code", "chemname", "chemical_class")) &
!is.integer(chemical_class$chem_code)) {
stop("The chem_code column should have integer values.")
}
if (!is.null(chemical_class) & is.data.frame(chemical_class) &
all(colnames(chemical_class) == c("chem_code", "chemname", "chemical_class")) &
!is.character(chemical_class$chemname)) {
stop("The chemname column should have character values.")
}
if (!is.null(chemical_class) & is.data.frame(chemical_class) &
all(colnames(chemical_class) == c("chem_code", "chemname", "chemical_class")) &
!is.character(chemical_class$chemical_class)) {
stop("The chemical_class column should have character values.")
}
if (unit == "section") {
if (aerial_ground) {
out <- help_sum_application(out, "chemical_class", "section", TRUE,
section_townships,
chemical_class = chemical_class,
chemical_class, section, county_name,
county_code, date, aerial_ground)
} else {
out <- help_sum_application(out, "chemical_class", "section", FALSE,
section_townships,
chemical_class = chemical_class,
chemical_class, section, county_name,
county_code, date)
}
} else if (unit == "township") {
if (aerial_ground) {
out <- help_sum_application(out, "chemical_class", "township", TRUE,
section_townships,
chemical_class = chemical_class,
chemical_class, township, county_name,
county_code, date, aerial_ground)
} else {
out <- help_sum_application(out, "chemical_class", "township", FALSE,
section_townships,
chemical_class = chemical_class,
chemical_class, township, county_name,
county_code, date)
}
}
}
} else {
if (!aerial_ground) {
out <- out %>% dplyr::select(-aerial_ground)
}
}
if ("prodno" %in% colnames(out)) {
out <- out %>% dplyr::mutate(prodno = as.integer(prodno))
}
return(out)
out
devtools::load_all()
clean_pur4 <- pull_clean_pur(2000, "yolo")
purexposure::county_codes
as.data.frame(purexposure::county_codes)
df6 <- pull_raw_pur(1995, "solano") %>% pull_clean_pur()
devtools::load_all()
setwd("~/Documents/purexposure")
devtools::load_all()
df6 <- pull_raw_pur(1995, "solano") %>% pull_clean_pur()
solano_95 <- pull_raw_pur(1995, "solano")
solano_95
solano_95$applic_dt
df6 <- pull_clean_pur(raw_pur_df = solano_95)
raw_pur_df = solano_95
is.null(raw_pur_df)
check <- colnames(raw_pur_df == c("use_no", "prodno", "chem_code",
"prodchem_pct", "lbs_chm_used",
"lbs_prd_used", "amt_prd_used",
"unit_of_meas", "acre_planted",
"unit_planted", "acre_treated",
"unit_treated", "applic_cnt", "applic_dt",
"applic_time", "county_cd", "base_ln_mer",
"township", "tship_dir", "range",
"range_dir", "section", "site_loc_id",
"grower_id", "license_no", "planting_seq",
"aer_gnd_ind", "site_code", "qualify_cd",
"batch_no", "document_no", "summary_cd",
"record_id"))
check
check <- colnames(raw_pur_df) == c("use_no", "prodno", "chem_code",
"prodchem_pct", "lbs_chm_used",
"lbs_prd_used", "amt_prd_used",
"unit_of_meas", "acre_planted",
"unit_planted", "acre_treated",
"unit_treated", "applic_cnt", "applic_dt",
"applic_time", "county_cd", "base_ln_mer",
"township", "tship_dir", "range",
"range_dir", "section", "site_loc_id",
"grower_id", "license_no", "planting_seq",
"aer_gnd_ind", "site_code", "qualify_cd",
"batch_no", "document_no", "summary_cd",
"record_id")
check
all(check)
devtools::load_all()
solano_95
df6 <- pull_clean_pur(raw_pur_df = solano_95)
devtools::load_all()
df6 <- pull_clean_pur(raw_pur_df = solano_95)
df6
toy <- data.frame(a = c(1:3, "/3", 0))
toy
toy <- data.frame(a = c(1:3, "?3", 0))
toy
c(grep("\\?", toy$a, value = TRUE), grep("0", toy$a, value = TRUE))
c(grep("\\\\", toy$a, value = TRUE), grep("0", toy$a, value = TRUE))
devtools::load_all()
df6 <- pull_clean_pur(raw_pur_df = solano_95)
