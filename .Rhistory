if (i == 1) {
cols_out <- col_vec
} else {
cols_out <- c(cols_out, col_vec)
}
}
cols_out <- c(cols_out, "#FFFFFF")
names(cols_out) <- categories
plot <- plot  +
ggplot2::scale_fill_manual(values = cols_out, name = legend_label)
}
plot <- plot +
ggplot2::theme_void() +
ggplot2::coord_map(xlim = long_range, ylim = lat_range)
if (crop) {
long_range <- grDevices::extendrange(pur_spatial$long)
lat_range <- grDevices::extendrange(pur_spatial$lat)
plot <- plot + ggplot2::coord_map(xlim = long_range, ylim = lat_range)
}
if (color_by == "percentile") {
out <- list(map = plot, data = pur_df3, cutoff_values = cutoff_values)
} else {
out <- list(map = plot, data = pur_df3)
}
return(out)
}
fresno_list <- purexposure::fresno_ex %>%
plot_county_application(spdf = fresno_spdf)
fresno_spdf <- purexposure::fresno_spdf
plot_county_application
fresno_list <- purexposure::fresno_ex %>%
plot_county_application(spdf = fresno_spdf)
devtools::document()
#'                           sum = "chemical_class",
#'                           chemical_class = chemical_class_df) %>%
#'    plot_county_application()
#' op_yuba$map
#' }
#'
#' @importFrom magrittr %>%
#' @importFrom rlang !!
#' @importFrom rlang :=
#' @export
plot_county_application <- function(clean_pur_df, county = NULL, pls = NULL,
color_by = "amount",
percentile = c(0.25, 0.5, 0.75),
start_date = NULL, end_date = NULL,
chemicals = "all", fill = "viridis",
crop = FALSE, alpha = 1, ...) {
if (is.null(pls)) {
if ("section" %in% colnames(clean_pur_df)) {
section_township <- "section"
} else {
section_township <- "township"
}
} else {
if ("section" %in% colnames(clean_pur_df)) {
section_township <- tolower(pls)
} else {
section_township <- "township"
}
}
if (!"pur_code" %in% colnames(clean_pur_df)) {
stop(paste0("The clean_pur_df argument should be an unaltered data frame ",
"returned from the pull_clean_pur() function."))
}
# pull county shapefile
if (is.null(county)) {
code <- unique(clean_pur_df$pur_code)
if (length(code) > 1) {
counties <- paste(find_counties(code, "names"), collapse = ", ")
stop(paste0("Your clan_pur_df data frame has data for more than one ",
"county (", counties, "). You can specify which county to ",
"plot data for with the county argument."))
}
} else {
code <- find_counties(county)
}
if (length(code) != 1) {
stop(paste0("Since there is data for more than one county in your ",
"clean_pur_df data frame,\nspecify which county you would ",
"like to plot data for with the county argument."))
}
args <- list(...)
if (is.null(args$spdf)) {
county_shp <- pull_spdf(code, section_township = section_township)
} else {
county_shp <- args$spdf
}
county_bbox <- as.data.frame(county_shp@bbox)
county_df <- spdf_to_df(county_shp)
if (chemicals == "all") {
pur_df <- clean_pur_df
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
if (!chemicals %in% unique(clean_pur_df$chemical_class)) {
stop(paste0("The input clean_pur_df is summed by chemical_class,\nand the ",
"input chemicals argument does not match any unique values ",
"of chemical_class."))
}
pur_df <- clean_pur_df %>% dplyr::filter(chemical_class == chemicals)
} else {
if (!toupper(chemicals) %in% unique(clean_pur_df$chemname)) {
stop(paste0("The input chemicals argument does not match any unique ",
"values\nof active ingredients (the chemname column) in the ",
"input clean_pur_df data frame."))
}
pur_df <- clean_pur_df %>% dplyr::filter(chemname == toupper(chemicals))
}
if (!is.null(start_date)) {
pur_df <- pur_df %>% dplyr::filter(date >= lubridate::ymd(start_date))
}
if (!is.null(end_date)) {
pur_df <- pur_df %>% dplyr::filter(date >= lubridate::ymd(start_date))
}
if (section_township == "section") {
pur_df2 <- pur_df %>%
dplyr::filter(pur_code == code) %>%
dplyr::group_by(section) %>%
dplyr::rename(pls = section) %>%
dplyr::summarise(kg = sum(kg_chm_used, na.rm = TRUE)) %>%
dplyr::mutate(kg = ifelse(is.na(kg), 0, kg))
} else {
pur_df2 <- pur_df %>%
dplyr::filter(pur_code == code) %>%
dplyr::group_by(township) %>%
dplyr::rename(pls = township) %>%
dplyr::summarise(kg = sum(kg_chm_used, na.rm = TRUE)) %>%
dplyr::mutate(kg = ifelse(is.na(kg), 0, kg))
}
if (color_by == "percentile") {
cutpoints_list <- help_categorize(section_data = pur_df2, buffer_or_county = "buffer",
percentile = percentile) # find cutpoints based on
# given data frame
pur_df3 <- cutpoints_list$df
labels <- cutpoints_list$categories
cutoff_values <- cutpoints_list$cutoff_values
viridis_discrete <- TRUE
fill_var <- "category"
} else {
pur_df3 <- pur_df2
viridis_discrete <- FALSE
fill_var <- "kg"
}
if (section_township == "section") {
county_df <- county_df %>% dplyr::rename(pls = MTRS)
} else if (section_township == "township") {
county_df <- county_df %>% dplyr::rename(pls = MTR)
}
colnames(pur_df3)[1] <- "pls"
pur_spatial <- pur_df3 %>% dplyr::left_join(county_df, by = "pls")
long_range <- grDevices::extendrange(county_df$long)
lat_range <- grDevices::extendrange(county_df$lat)
suppressMessages(suppressWarnings(
location <- ggmap::get_map(c(floor(county_bbox$min[1]), floor(county_bbox$min[2]),
ceiling(county_bbox$max[1]), ceiling(county_bbox$max[2])),
color = "bw")))
legend_label <- paste0("Applied Pesticides\n(kg/", section_township, ")")
colormaps_vec <- unlist(colormap::colormaps)
names(colormaps_vec) <- NULL
if (!fill %in% colormaps_vec) {
stop(paste0("The fill argument should be a color palette from the ",
"colormap package."))
}
gradient <- colormap::colormap(fill, nshades = 1000, alpha = alpha)
# gradient <- c("#FFFFFF", gradient)
plot <- ggmap::ggmap(location) +
ggplot2::geom_polygon(data = county_df, ggplot2::aes(x = long, y = lat, group = group),
color = "black", fill = NA) +
ggplot2::geom_polygon(data = pur_spatial, ggplot2::aes_string(x = "long", y = "lat", ## aes_string
group = "group",
fill = fill_var))
if (color_by == "amount") {
plot <- plot +
scale_fill_gradientn2(colours = gradient, alpha = alpha, name = legend_label,
na.value = "#FFFFFF")
} else if (color_by == "percentile") {
categories <- as.character(levels(pur_spatial$category))
if (!"None recorded" %in% categories) {
categories <- c(categories, "missing")
}
n_cols <- as.integer(length(gradient)/(length(categories)-1))
end_i <- length(categories) - 1
for (i in 1:end_i) {
col_vec <- gradient[n_cols*i]
if (i == 1) {
cols_out <- col_vec
} else {
cols_out <- c(cols_out, col_vec)
}
}
cols_out <- c(cols_out, "#FFFFFF")
names(cols_out) <- categories
plot <- plot  +
ggplot2::scale_fill_manual(values = cols_out, name = legend_label)
}
plot <- plot +
ggplot2::theme_void() +
ggplot2::coord_map(xlim = long_range, ylim = lat_range)
if (crop) {
long_range <- grDevices::extendrange(pur_spatial$long)
lat_range <- grDevices::extendrange(pur_spatial$lat)
plot <- plot + ggplot2::coord_map(xlim = long_range, ylim = lat_range)
}
if (color_by == "percentile") {
out <- list(map = plot, data = pur_df3, cutoff_values = cutoff_values)
} else {
out <- list(map = plot, data = pur_df3)
}
return(out)
}
fresno_list <- purexposure::fresno_ex %>%
plot_county_application(spdf = fresno_spdf)
names(fresno_list)
fresno_list$map
products_2000 <- pull_product_table(2000)
usethis::use_data(products_2000, overwrite = TRUE)
# fresno pur raw
fresno_ex_raw <- pull_raw_pur(2000, "fresno")
usethis::use_data(fresno_ex_raw, overwrite = TRUE)
fresno_ex_raw <- fresno_ex_raw %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31"))
# fresno pur raw
fresno_ex_raw <- pull_raw_pur(2000, "fresno")
fresno_ex_raw <- fresno_ex_raw %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31"))
head(fresno_ex_raw)
head(fresno_ex_raw$applic_dt)
class(fresno_ex_raw$applic_dt)
fresno_ex_raw <- fresno_ex_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt)) %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31")) %>%
dplyr::mutate(applic_dt = as.character(applic_dt))
fresno_ex_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
fresno_ex_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt)) %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31"))
fresno_ex_raw <- fresno_ex_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
head(fresno_ex_raw$applic_dt)
class(fresno_ex_raw$applic_dt)
unique(fresno_ex_raw$applic_dt)
# fresno pur raw
fresno_ex_raw <- pull_raw_pur(2000, "fresno")
fresno_ex_raw <- fresno_ex_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt)) %>%
dplyr::filter(applic_dt >= lubridate::ymd("2000-01-01") &
applic_dt <= lubridate::ymd("2000-01-31")) %>%
dplyr::mutate(applic_dt = as.character(applic_dt))
usethis::use_data(fresno_ex_raw, overwrite = TRUE)
nrow(fresno_ex_raw)
ncol(fresno_ex_raw)
tail(fresno_ex_raw$applic_dt)
fresno_raw <- pull_raw_pur(2000, "fresno")
fresno_raw <- fresno_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt)) %>%
dplyr::filter(applic_dt >= lubridate::ymd("2000-01-01") &
applic_dt <= lubridate::ymd("2000-01-31")) %>%
dplyr::mutate(applic_dt = as.character(applic_dt))
usethis::use_data(fresno_raw, overwrite = TRUE)
# fesno pur clean
fresno_clean <- pull_clean_pur(2000, "fresno")
fresno_clean <- fresno_clean %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31"))
usethis::use_data(fresno_clean, overwrite = TRUE)
product_df <- purexposure::products_2000
devtools::document()
product_df <- purexposure::products_2000
#'   Included if `by_year` is set to TRUE.}
#' }
#'
#' @examples
#' product_df <- purexposure::products_2000
#' prod_df <- find_product_name(2000, "mosquito", product_df = product_df)
#' \donttest{
#' prod_df2 <- find_product_name(2010, c("insecticide", "rodenticide"))
#' }
#' @export
find_product_name <- function(years, products = "all", quiet = FALSE,
by_year = FALSE, ...) {
args <- list(...)
if (is.null(args$product_df)) {
prod_df <- pull_product_table(years, quiet = quiet)
} else {
prod_df <- product_df
}
for (i in 1:length(products)) {
df <- help_find_product(products[i], prod_df)
if (i == 1) {
out <- df
} else {
out <- rbind(out, df)
}
}
out <- unique(out) %>% dplyr::select(1:4, product, year)
if (!by_year) {
out <- out %>% dplyr::select(-year) %>% unique()
}
return(out)
}
prod_df <- find_product_name(2000, "mosquito", product_df = product_df)
prod_df
devtools::document()
?find_product_name
find_counties(c("01", "06005", "el dorado"), return = "fips_codes")
find_counties(c("01", "06005", "el dorado"), return = "names")
plot_locations_exposure(purexposure::exposure_ex$exposure)
purexposure::exposure_ex$exposure
rbind(purexposure::exposure_ex$exposure,
purexposure::exposure_ex2$exposure)
devtools::document()
?write_exposure
pur <- purexposure::fresno_clean
spdf <- purexposure::fresno_spdf
df <- data.frame(location = "-119.726751, 36.660967",
start_date = "2000-01-01",
end_date = "2000-12-31")
temp <- tempdir()
write_exposure(pur, df, 3000, temp, spdf = spdf)
devtools::document()
write_exposure(pur, df, 3000, temp, spdf = spdf)
devtools::document()
?pull_product_table
df <- products_2000
dim(df)
devtools::document()
devtools::document()
devtools::document()
devtools::document()
fresno <- purexposure::fresno_spdf
fresno %>% spdf_to_df %>% df_plot()
devtools::document()
#'
#' plot_list <- plot_county_locations(c("san bernardino", "ventura"),
#'                                    separate_plots = TRUE)
#' names(plot_list)
#' plot_list[[1]]
#' plot_list[[2]]
#' }
#' @importFrom magrittr %>%
#' @importFrom rlang !!
#' @export
plot_county_locations <- function(counties_or_df, separate_plots = FALSE,
fill_color = "red", alpha = 0.5, ...) {
ca_shp <- purexposure::california_shp
ca_df <- spdf_to_df(ca_shp)
if (!is.vector(counties_or_df) & !is.data.frame(counties_or_df)) { #overkill
stop(paste0("The counties_or_df argument should be either a character",
" vector of county names or codes or a PUR data frame."))
}
if (is.vector(counties_or_df)) {
counties <- find_counties(counties_or_df, return = "names")
}
if (is.data.frame(counties_or_df)) {
check <- any(c("county_cd", "county_name", "pur_code", "fips_code") %in%
colnames(counties_or_df))
if (!check) {
stop(paste0("The counties_or_df data frame should have either a county_cd,",
" county_name, pur_code, or fips_code column.\nThis data",
" frame should be returned from either pull_pur_file(),",
" pull_raw_pur(), or pull_clean_pur()."))
}
county_col <- grep("county_cd", colnames(counties_or_df), value = TRUE)
if (length(county_col) == 0) {
county_col <- grep("county_name", colnames(counties_or_df), value = TRUE)
if (length(county_col) == 0) {
county_col <- grep("pur_code", colnames(counties_or_df), value = TRUE)
if (length(county_col) == 0) {
county_col <- grep("fips_code", colnames(counties_or_df), value = TRUE)
}
}
}
counties <- counties_or_df %>%
dplyr::select(!!county_col) %>%
unique() %>%
tibble_to_vector()
}
# pull county shapefiles
args <- list(...)
if (is.null(args$spdf)) {
county_shps <- purrr::map(counties, pull_spdf)
county_dfs <- suppressWarnings(purrr::map(county_shps, spdf_to_df))
} else {
county_dfs <- list(args$spdf %>% spdf_to_df)
}
ca <- df_plot(ca_df)
plot <- ca + ggplot2::geom_polygon(data = county_dfs[[1]],
ggplot2::aes(x = long, y = lat, group = group),
color = "transparent", fill = fill_color, alpha =
alpha)
if (separate_plots) {
if (length(counties) > 1) {
out <- list()
out[[1]] <- plot
for (i in utils::tail(1:length(counties), -1)) {
out[[i]] <- ca + ggplot2::geom_polygon(data = county_dfs[[i]],
ggplot2::aes(x = long, y = lat, group = group),
color = "transparent", fill = fill_color, alpha =
alpha)
}
names(out) <- counties
} else {
out <- plot
}
} else {
if (length(county_dfs) > 1) {
for (i in utils::tail(1:length(counties), -1)) {
plot <- plot + ggplot2::geom_polygon(data = county_dfs[[i]],
ggplot2::aes(x = long, y = lat, group = group),
color = "transparent", fill = fill_color, alpha =
alpha)
out <- plot
}
} else {
out <- plot
}
}
return(out)
}
fresno_spdf <- purexposure::fresno_spdf
plot_county_locations("fresno", spdf = fresno_spdf)}
plot_county_locations("fresno", spdf = fresno_spdf)
devtools::document()
?plot_county_locations
plot_list <- plot_county_locations(c("san bernardino", "ventura"),
separate_plots = TRUE)
devtools::document()
devtools::document()
toy <- data.frame(x = 1:10, y = as.character(c(11:20)))
toy
str(toy)
toy %>% dplyr::filter(x %in% c(1:5), y %in% c("11", "12"))
toy %>% dplyr::filter(x %in% c(1:5) & y %in% c("11", "12"))
toy %>% dplyr::filter(x %in% c(1:5) | y %in% c("11", "12"))
dir.create("inst")
dir.create("inst/extdata")
# fresno pur raw
fresno_raw <- pull_raw_pur(2000, "fresno")
fresno_raw <- fresno_raw %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt)) %>%
dplyr::filter(applic_dt >= lubridate::ymd("2000-01-01") &
applic_dt <= lubridate::ymd("2000-01-31")) %>%
dplyr::mutate(applic_dt = as.character(applic_dt))
saveRDS(fresno_raw, file = "inst/extdata/fresno_raw.rds")
# fesno pur clean
fresno_clean <- pull_clean_pur(2000, "fresno")
fresno_clean <- fresno_clean %>%
dplyr::filter(date >= lubridate::ymd("2000-01-01") &
date <= lubridate::ymd("2000-01-31"))
saveRDS(fresno_clean, file = "inst/extdata/fresno_clean.rds")
exposure_ex <- purexposure::fresno_clean %>%
calculate_exposure(location = "-119.726751, 36.660967", radius = 3000)
exposure_ex$county_plot <- NULL
saveRDS(exposure_ex, file = "inst/extdata/exposure_ex")
# fresno exposure #2
exposure_ex2 <- fresno_clean %>%
calculate_exposure(location = "-119.247100, 37.204875", radius = 3000)
saveRDS(exposure_ex, file = "inst/extdata/exposure_ex.rds")
exposure_ex2$county_plot <- NULL
saveRDS(exposure_ex2, file = "inst/extdata/exposure_ex2.rds")
# fresno spdf
fresno_spdf <- pull_spdf("fresno")
saveRDS(fresno_spdf, file = "inst/extdata/fresno_spdf.rds")
# products table for 2000
products_2000 <- pull_product_table(2000)
saveRDS(products_2000, file = "inst/extdata/products_2000.rds")
devtools::document()
devtools::document()
system.file("extdata", "fresno_clean.rds",
package = "purexposure")
# fresno exposure #1
fresno_clean <- readRDS(system.file("extdata", "fresno_clean.rds",
package = "purexposure"))
fresno_clean
devtools::document()
fresno_spdf <- readRDS(system.file("extdata", "fresno_spdf.rds",
package = "purexposure))
fresno_spdf <- readRDS(system.file("extdata", "fresno_spdf.rds",
package = "purexposure))
devtools::document()
spdf <- readRDS(system.file("extdata", "fresno_spdf.rds", package = "purexposure"))
exp1 <- readRDS(system.file("extdata", "exposure_ex.rds", package = "purexposure"))
exp2 <- readRDS(system.file("extdata", "exposure_ex2.rds", package = "purexposure"))
exposure_df <- rbind(exp1, exp2)
exposure_df
readRDS(system.file("extdata", "exposure_ex2.rds", package = "purexposure"))
spdf <- readRDS(system.file("extdata", "fresno_spdf.rds", package = "purexposure"))
exp1 <- readRDS(system.file("extdata", "exposure_ex.rds", package = "purexposure"))$exposure
exp2 <- readRDS(system.file("extdata", "exposure_ex2.rds", package = "purexposure"))$exposure
exposure_df <- rbind(exp1, exp2)
plot_locations_exposure(exposure_df, spdf = spdf)}
plot_locations_exposure(exposure_df, spdf = spdf)
devtools::document()
devtools::document()
codes <- purexposure::county_codes
codes
library(countyweather)
?daily_fips
library(devtools)
check()
shp <- purexposure::california_shp
plot(shp)
shp %>% purexposure::spdf_to_df() %>% purexposure::df_plot()
library(magrittr)
shp %>% purexposure::spdf_to_df() %>% purexposure::df_plot()
devtools::document()
build()
