if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
} else {
row_out <- rbind(row_out, row)
starting_point <- length(meta_list)
meta_list_vec <- (1:unique(row$n_row)) + starting_point
for (l in meta_list_vec) {
meta_row <- row[l-starting_point,]
chemicals_match <- meta_row$chemicals
aerial_ground_match <- meta_row$aerial_ground
radius_match <- meta_row$radius
if (length(unique(meta_data$chemicals)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(chemicals == chemicals_match)
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data_row %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
}
}
if (!dir.exists(directory)) {
dir.create(directory)
}
row_out <- row_out %>%
dplyr::select(-n_row) %>%
dplyr::mutate(aerial_ground = ifelse(aerial_ground == "NA", NA, aerial_ground),
chemicals = ifelse(chemicals == "NA", NA, chemicals))
saveRDS(row_out, file = paste0(directory, "/exposure_df.rds"))
saveRDS(meta_list, file = paste0(directory, "/meta_data.rds"))
pad_width <- nchar(sub('^0+','',sub('\\.', '', nrow(row_out))))
directory
i <- 1
clean_pur_df <- fresno_data
locations_dates_df <- locations_dates[i, ]
radii <- 3000
directory <- paste0("~/Desktop/first_run_", i)
chemicals <- "chemical_class"
aerial_ground <- FALSE
write_plots <- FALSE
verbose <- TRUE
locations <- as.character(unique(locations_dates_df$location))
for (i in 1:length(locations)) {
if (length(grep("-", locations[i])) == 1) {
latlon <- locations[i]
latlon_vec <- as.numeric(as.vector(sapply(unlist(strsplit(latlon, ",")),
stringr::str_trim)))
address_x <- latlon_vec[1]
address_y <- latlon_vec[2]
latlon_out <- latlon_vec
} else {
address <- locations[i]
latlon_df <- help_geocode(address)
address_x <- latlon_df$lon
address_y <- latlon_df$lat
latlon_out <- as.numeric(c(address_x, address_y))
}
latlon_ch <- paste0(latlon_out[1], ", ", latlon_out[2])
if (i == 1) {
latlon <- latlon_ch
} else {
latlon <- c(latlon, latlon_ch)
}
}
loc_df <- data.frame(location = unique(locations_dates_df$location),
latlon_loc = latlon)
locations_dates_df <- locations_dates_df %>%
dplyr::full_join(loc_df, by = "location") %>%
dplyr::rename(original_location = location,
location = latlon_loc)
radius_list <- list()
for (i in 1:length(radii)) {
radius_list[[i]] <- locations_dates_df %>% dplyr::mutate(radius = radii[i])
}
exposure_mat <- do.call("rbind", radius_list)
safe_calculate_exposure <- purrr::safely(calculate_exposure)
exposure_args <- list(location = as.character(exposure_mat$location),
radius = as.numeric(exposure_mat$radius),
start_date = as.character(exposure_mat$start_date),
end_date = as.character(exposure_mat$end_date),
original_location = as.character(exposure_mat$original_location))
exposure_list <- purrr::pmap(exposure_args, safe_calculate_exposure,
clean_pur_df = clean_pur_df, chemicals = chemicals,
aerial_ground = aerial_ground, verbose = verbose)
meta_list <- list()
for (i in 1:length(exposure_list)) {
if (!is.null(exposure_list[[i]]$error)) {
row <- data.frame(exposure = NA, chemicals = chemicals,
start_date = exposure_mat[i, ]$start_date,
end_date = exposure_mat[i, ]$end_date,
aerial_ground = NA,
location = exposure_mat[i, ]$original_location,
radius = exposure_mat[i, ]$radius,
longitude = NA, latitude = NA,
error_message = exposure_list[[i]]$error,
n_row = 1)
meta_data <- data.frame(pls = NA, chemicals = chemicals, percent = NA,
kg = NA, kg_intersection = NA,
start_date = exposure_mat[i, ]$start_date,
end_date = exposure_mat[i, ]$end_date,
aerial_ground = NA, none_recorded = NA,
location = exposure_mat[i, ]$original_location,
radius = exposure_mat[i, ]$radius,
area = NA, error_message = exposure_list[[i]]$error)
} else {
error_message <- NA
row <- exposure_list[[i]]$result$exposure %>%
dplyr::mutate(error_message = NA) %>%
dplyr::ungroup() %>%
dplyr::mutate(n_row = n())
meta_data <- exposure_list[[i]]$result$meta_data %>%
dplyr::mutate(error_message = NA,
location = exposure_mat[i, ]$original_location)
}
if (i == 1) {
row_out <- row
for (l in 1:unique(row$n_row)) {
meta_row <- row[l,]
chemicals_match <- meta_row$chemicals
aerial_ground_match <- meta_row$aerial_ground
radius_match <- meta_row$radius
if (length(unique(meta_data$chemicals)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(chemicals == chemicals_match)
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data_row %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
} else {
row_out <- rbind(row_out, row)
starting_point <- length(meta_list)
meta_list_vec <- (1:unique(row$n_row)) + starting_point
for (l in meta_list_vec) {
meta_row <- row[l-starting_point,]
chemicals_match <- meta_row$chemicals
aerial_ground_match <- meta_row$aerial_ground
radius_match <- meta_row$radius
if (length(unique(meta_data$chemicals)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(chemicals == chemicals_match)
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data_row %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
}
}
if (!dir.exists(directory)) {
dir.create(directory)
}
row_out <- row_out %>%
dplyr::select(-n_row) %>%
dplyr::mutate(aerial_ground = ifelse(aerial_ground == "NA", NA, aerial_ground),
chemicals = ifelse(chemicals == "NA", NA, chemicals))
saveRDS(row_out, file = paste0(directory, "/exposure_df.rds"))
saveRDS(meta_list, file = paste0(directory, "/meta_data.rds"))
pad_width <- nchar(sub('^0+','',sub('\\.', '', nrow(row_out))))
readRDS("~/Desktop/first_run_1/exposure_df.rds")
write_exposure <- function(clean_pur_df, locations_dates_df, radii, directory,
chemicals = "all", aerial_ground = FALSE,
verbose = TRUE) {
locations <- as.character(unique(locations_dates_df$location))
for (i in 1:length(locations)) {
if (length(grep("-", locations[i])) == 1) {
latlon <- locations[i]
latlon_vec <- as.numeric(as.vector(sapply(unlist(strsplit(latlon, ",")),
stringr::str_trim)))
address_x <- latlon_vec[1]
address_y <- latlon_vec[2]
latlon_out <- latlon_vec
} else {
address <- locations[i]
latlon_df <- help_geocode(address)
address_x <- latlon_df$lon
address_y <- latlon_df$lat
latlon_out <- as.numeric(c(address_x, address_y))
}
latlon_ch <- paste0(latlon_out[1], ", ", latlon_out[2])
if (i == 1) {
latlon <- latlon_ch
} else {
latlon <- c(latlon, latlon_ch)
}
}
loc_df <- data.frame(location = unique(locations_dates_df$location),
latlon_loc = latlon)
locations_dates_df <- locations_dates_df %>%
dplyr::full_join(loc_df, by = "location") %>%
dplyr::rename(original_location = location,
location = latlon_loc)
radius_list <- list()
for (i in 1:length(radii)) {
radius_list[[i]] <- locations_dates_df %>% dplyr::mutate(radius = radii[i])
}
exposure_mat <- do.call("rbind", radius_list)
safe_calculate_exposure <- purrr::safely(calculate_exposure)
exposure_args <- list(location = as.character(exposure_mat$location),
radius = as.numeric(exposure_mat$radius),
start_date = as.character(exposure_mat$start_date),
end_date = as.character(exposure_mat$end_date),
original_location = as.character(exposure_mat$original_location))
exposure_list <- purrr::pmap(exposure_args, safe_calculate_exposure,
clean_pur_df = clean_pur_df, chemicals = chemicals,
aerial_ground = aerial_ground, verbose = verbose)
meta_list <- list()
for (i in 1:length(exposure_list)) {
if (!is.null(exposure_list[[i]]$error)) {
row <- data.frame(exposure = NA, chemicals = chemicals,
start_date = exposure_mat[i, ]$start_date,
end_date = exposure_mat[i, ]$end_date,
aerial_ground = NA,
location = exposure_mat[i, ]$original_location,
radius = exposure_mat[i, ]$radius,
longitude = NA, latitude = NA,
error_message = exposure_list[[i]]$error,
n_row = 1)
meta_data <- data.frame(pls = NA, chemicals = chemicals, percent = NA,
kg = NA, kg_intersection = NA,
start_date = exposure_mat[i, ]$start_date,
end_date = exposure_mat[i, ]$end_date,
aerial_ground = NA, none_recorded = NA,
location = exposure_mat[i, ]$original_location,
radius = exposure_mat[i, ]$radius,
area = NA, error_message = exposure_list[[i]]$error)
} else {
error_message <- NA
row <- exposure_list[[i]]$result$exposure %>%
dplyr::mutate(error_message = NA) %>%
dplyr::ungroup() %>%
dplyr::mutate(n_row = n())
meta_data <- exposure_list[[i]]$result$meta_data %>%
dplyr::mutate(error_message = NA,
location = exposure_mat[i, ]$original_location)
}
if (i == 1) {
row_out <- row
for (l in 1:unique(row$n_row)) {
meta_row <- row[l,]
chemicals_match <- meta_row$chemicals
aerial_ground_match <- meta_row$aerial_ground
radius_match <- meta_row$radius
if (length(unique(meta_data$chemicals)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(chemicals == chemicals_match)
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data_row %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
} else {
row_out <- rbind(row_out, row)
starting_point <- length(meta_list)
meta_list_vec <- (1:unique(row$n_row)) + starting_point
for (l in meta_list_vec) {
meta_row <- row[l-starting_point,]
chemicals_match <- meta_row$chemicals
aerial_ground_match <- meta_row$aerial_ground
radius_match <- meta_row$radius
if (length(unique(meta_data$chemicals)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(chemicals == chemicals_match)
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data_row %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
}
} else {
if (class(aerial_ground_match) != "logical" & aerial_ground_match %in%
c("A", "G", "O")) {
meta_data_row <- meta_data %>%
dplyr::filter(aerial_ground == aerial_ground_match)
if (length(unique(meta_data_row$radius)) > 1) {
meta_data_row <- meta_data_row %>%
dplyr::filter(radius == radius_match)
}
} else {
if (length(unique(meta_data$radius)) > 1) {
meta_data_row <- meta_data %>%
dplyr::filter(radius == radius_match)
}
}
}
if (!exists("meta_data_row")) {
meta_data_row <- meta_data
}
meta_list[[l]] <- meta_data_row
}
}
}
if (!dir.exists(directory)) {
dir.create(directory)
}
row_out <- row_out %>%
dplyr::select(-n_row) %>%
dplyr::mutate(aerial_ground = ifelse(aerial_ground == "NA", NA, aerial_ground),
chemicals = ifelse(chemicals == "NA", NA, chemicals))
saveRDS(row_out, file = paste0(directory, "/exposure_df.rds"))
saveRDS(meta_list, file = paste0(directory, "/meta_data.rds"))
}
write_exposure(clean_pur_df, locations_dates_df, radii, "~/Desktop", "chemical_class")
clean_pur_df <- fresno_data
locations_dates_df <- locations_dates[i, ]
radii <- 3000
directory <- paste0("~/Desktop/first_run_", i)
chemicals <- "chemical_class"
aerial_ground <- FALSE
write_plots <- FALSE
verbose <- TRUE
write_exposure(clean_pur_df, locations_dates_df, radii, "~/Desktop", "chemical_class")
nrow(locations_dates)
for (i in 1:nrow(locations_dates)) {
possibleError <- tryCatch({
clean_pur_df <- fresno_data
locations_dates_df <- locations_dates[i, ]
radii <- 3000
directory <- paste0("~/Desktop/first_run_", i)
chemicals <- "chemical_class"
aerial_ground <- FALSE
write_plots <- FALSE
verbose <- TRUE
write_exposure(clean_pur_df, locations_dates_df, radii, directory,
"chemical_class")
}
,
error = function(e) {
e
message(paste0("problem with row ", i))
}
)
if (inherits(possibleError, "error")) next
}
list.files("~/Desktop")
"grep"
?grep
grep("first_run", list.files("~/Desktop"), value = TRUE)
grep("first_run", list.files("~/Desktop"), value = TRUE)
grep("first_run", list.files("~/Desktop"), value = TRUE)[2:113]
grep("first_run_", list.files("~/Desktop"), value = TRUE)
directories <- grep("first_run_", list.files("~/Desktop"), value = TRUE)
?file.rename
numbers <- as.numeric(gsub("first_run_", "", directories))
numbers
i <- 1
df <- readRDS(paste0("~/Desktop/first_run_", numbers[i], "/exposure_df.rds"))
df
df <- df %>% mutate(i = numbers[i])
df
for (i in 1:length(directories)) {
df <- readRDS(paste0("~/Desktop/first_run_", numbers[i], "/exposure_df.rds"))
df <- df %>% mutate(row_number = numbers[i])
if (i == 1) {
out <- df
} else {
out <- rbind(out, df)
}
}
out
saveRDS(out, file = "~/Desktop/first_run.rds")
