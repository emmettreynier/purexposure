clean_pur_df <- pull_clean_pur(1990:1992, "fresno", chemicals = c("methyl bromide",                                                "sulfur"))
clean_pur_df
facet
facet <- TRUE
y_axis <- "fixed"
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemname)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemical_class)
}
} else {
plot <- clean_pur_df %>%
dplyr::group_by(date)
}
plot
plot <- plot %>%
dplyr::summarise(kg_perday = sum(kg_chm_used, na.rm = TRUE)) %>%
ggplot2::ggplot(ggplot2::aes(x = date, y = kg_perday)) +
ggplot2::geom_line() +
ggthemes::theme_base() +
ggplot2::labs(x = "Application date",
y = "Kilograms of active ingredient applied per day ")
plot
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- plot %>%
ggplot2::facet_wrap(~chemname, scales = y_axis)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- plot %>%
ggplot2::facet_wrap(~chemical_class, scales = y_axis )
}
}
plot %>%
ggplot2::facet_wrap(~chemname, scales = y_axis)
y_axis
chemname
plot_application_timeseries <- function(clean_pur_df, facet = FALSE,
y_axis = "fixed") {
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemname)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemical_class)
}
} else {
plot <- clean_pur_df %>%
dplyr::group_by(date)
}
plot <- plot %>%
dplyr::summarise(kg_perday = sum(kg_chm_used, na.rm = TRUE)) %>%
ggplot2::ggplot(ggplot2::aes(x = date, y = kg_perday)) +
ggplot2::geom_line() +
ggthemes::theme_base() +
ggplot2::labs(x = "Application date",
y = "Kilograms of active ingredient applied per day ")
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- plot +
ggplot2::facet_wrap(~chemname, scales = y_axis)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- plot +
ggplot2::facet_wrap(~chemical_class, scales = y_axis )
}
}
return(plot)
}
pull_clean_pur(1990:1992, "fresno", chemicals = c("methyl bromide",
"sulfur")) %>%
plot_application_timeseries(facet = TRUE)
plot_application_timeseries <- function(clean_pur_df, facet = FALSE,
y_axis = "fixed") {
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemname)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- clean_pur_df %>%
dplyr::group_by(date, chemical_class)
}
} else {
plot <- clean_pur_df %>%
dplyr::group_by(date)
}
plot <- plot %>%
dplyr::summarise(kg_perday = sum(kg_chm_used, na.rm = TRUE)) %>%
ggplot2::ggplot(ggplot2::aes(x = date, y = kg_perday)) +
ggplot2::geom_line() +
ggplot2::theme_minimal() +
ggplot2::labs(x = "Application date",
y = "Kilograms of active ingredient\napplied per day ")
if (facet) {
if ("chemname" %in% colnames(clean_pur_df)) {
plot <- plot +
ggplot2::facet_wrap(~chemname, scales = y_axis)
} else if ("chemical_class" %in% colnames(clean_pur_df)) {
plot <- plot +
ggplot2::facet_wrap(~chemical_class, scales = y_axis )
}
}
return(plot)
}
pull_clean_pur(1990:1992, "fresno") %>%
dplyr::filter(chemname %in% c("methyl bromide", "sulfur")) %>%
plot_application_timeseries(facet = TRUE)
test <- pull_clean_pur(1990:1992, "fresno")
pull_clean_pur(1990:1992, "fresno") %>%
dplyr::filter(chemname %in% toupper(c("methyl bromide", "sulfur"))) %>%
plot_application_timeseries(facet = TRUE)
as.data.frame(purexposure::county_codes)
pull_clean_pur(2000, "riverside") %>% plot_application_timeseries()
devtools::document()
setwd("~/Documents/purexposure")
pull_clean_pur(2000, "riverside") %>% plot_application_timeseries()
devtools::document()
source('~/Documents/purexposure/R/02-find.R')
prod_df <- find_product_name(2000, "mosquito")
source('~/Documents/purexposure/R/02-find.R')
source('~/Documents/purexposure/R/03-pull.R')
source('~/Documents/purexposure/R/05-plot.R')
devtools::document()
?purexposure
devtools::document()
devtools::document()
?purexposure
devtools::document()
?purexposure
devtools::document()
?purexposure
devtools::document()
?purexposure
devtools::document()
?purexposure
?build_manual
devtools::build_manual()
devtools::build_manual(path = "~/Desktop")
pkg <- "."
path <- "~/Desktop"
pkg <- as.package(pkg)
?build_manual
Rd2pdf(files = list.files("man"))
RdUtils::Rd2pdf(files = list.files("man"))
library(purexposure)
library(purexposure)
pack <- "purexposure"
path <- find.package(pack)
system(paste(shQuote(file.path(R.home("bind"), "R")), "CMD", "Rd2pdf", shQuote(path)))
system(paste(shQuote(file.path(R.home("bin"), "R")), "CMD", "Rd2pdf", shQuote(path)))
library(tools)
devtools::build_manual()
devtools::build_manual()
devtools::build_manual()
sessionInfo()
library(tidyverse)
sessionInfo()
?pull_clean_pur
devtools::load_all()
?pull_clean_pur
devtools::load_all()
years <- 2010
counties <- "tulare"
sum_application <- TRUE
unit <- "township"
aerial_ground <- FALSE
sum = "all"
chemical_class = NULL
verbose = TRUE
download_progress = TRUE
raw_pur_df = NULL
if (is.null(raw_pur_df)) {
raw_df <- pull_raw_pur(years = years, counties = counties, verbose = verbose,
download_progress = download_progress)
} else {
check <- colnames(raw_pur_df) == c("use_no", "prodno", "chem_code",
"prodchem_pct", "lbs_chm_used",
"lbs_prd_used", "amt_prd_used",
"unit_of_meas", "acre_planted",
"unit_planted", "acre_treated",
"unit_treated", "applic_cnt", "applic_dt",
"applic_time", "county_cd", "base_ln_mer",
"township", "tship_dir", "range",
"range_dir", "section", "site_loc_id",
"grower_id", "license_no", "planting_seq",
"aer_gnd_ind", "site_code", "qualify_cd",
"batch_no", "document_no", "summary_cd",
"record_id")
if (!all(check)) {
stop(paste0("The raw_pur_df data frame should be returned from ",
"pull_raw_pur() and should have 33 columns."))
}
unique_years <- raw_pur_df %>%
dplyr::mutate(year = lubridate::year(lubridate::ymd(applic_dt))) %>%
dplyr::select(year) %>%
unique() %>%
tibble_to_vector()
unique_counties <- raw_pur_df %>%
dplyr::select(county_cd) %>%
unique() %>%
tibble_to_vector() %>%
find_counties(return = "codes")
if (is.character(years)) {
if (years == "all") {
years_check <- unique_years
}
} else {
years_check <- years
}
if (counties == "all") {
counties_check <- unique_counties
} else {
counties_check <- find_counties(counties)
}
years_check <- years_check %in% unique_years
if (!all(years_check)) {
stop(paste0("The years argument specifies years not present in the given ",
"raw_pur_df data frame."))
}
counties_check <- counties_check %in% unique_counties
if (!all(counties_check)) {
stop(paste0("The counties argument specifies counties not present in the ",
"given raw_pur_df data frame."))
}
raw_df <- raw_pur_df
}
raw_df
df <- raw_df %>%
dplyr::mutate(township_pad = stringr::str_pad(raw_df$township, 2, "left", pad = "0"),
range = stringr::str_pad(raw_df$range, 2, "left", pad = "0"),
section = stringr::str_pad(raw_df$section, 2, "left", pad = "0"),
MTRS = as.character(paste0(base_ln_mer, township_pad, tship_dir,
range, range_dir, section)),
township = as.character(paste0(base_ln_mer, township_pad, tship_dir)),
MTR = as.character(paste0(township, range, range_dir))) %>%
dplyr::select(chem_code, lbs_chm_used, MTRS, MTR, county_cd, applic_dt,
aer_gnd_ind, use_no, acre_treated, unit_treated, prodno) %>%
dplyr::mutate(unit_treated = as.factor(unit_treated)) %>%
dplyr::filter(!MTRS %in% c(".0..0..0.", ".00.00.00", "NANANANANANA"),
unit_treated %in% c("A", "S")) %>%
dplyr::mutate(acre_treated = as.numeric(acre_treated),
lbs_chm_used = as.numeric(lbs_chm_used),
acre_treated = ifelse(unit_treated == "S",
acre_treated * 2.29568e-5,
acre_treated),
unit_treated = "A", # going to remove this later - all acres
lbs_per_acre = lbs_chm_used/acre_treated,
chem_code = as.integer(chem_code))
df
calc_max <- df %>%
dplyr::mutate(year = as.character(lubridate::year(lubridate::ymd(applic_dt)))) %>%
dplyr::group_by(chem_code, year) %>%
dplyr::summarize(mean = mean(lbs_per_acre, na.rm = TRUE),
sd = sd(lbs_per_acre, na.rm = TRUE)) %>%
dplyr::mutate(calc_max = mean + 2*sd)
if (!"all" %in% chemicals) {
years_chemicals <- expand.grid(year = years, chemicals = chemicals) %>%
dplyr::group_by(year) %>%
tidyr::nest() %>%
dplyr::mutate(chemicals = purrr::map(data, tibble_to_vector))
chem_df <- purrr::map2_dfr(years_chemicals$year, years_chemicals$chemicals,
find_chemical_codes) %>% unique()
df <- df %>%
dplyr::filter(chem_code %in% chem_df$chem_code) %>%
dplyr::left_join(chem_df, by = "chem_code") %>%
dplyr::select(-chemical) %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
# chemicals
if (nrow(df) == 0) {
if (length(chemicals) == 1) {
chem_message <- paste0(chemicals)
} else if (length(chemicals) == 2) {
chem_message <- paste0(chemicals[1], " or ", chemicals[2])
} else if (length(chemicals) > 2 & length(chemicals) < 11) {
chems_vec <- chemicals[1:length(chemicals)-1]
chems_vec <- paste(chems_vec, collapse = ", ")
chem_message <- paste0(chems_vec, ", or ", chemicals[length(chemicals)])
} else if (length(chemicals) >= 11) {
chem_message <- "these chemicals"
}
# years
if (length(years) == 1) {
year_message <- years
} else if (length(years) == 2) {
year_message <- paste0(years[1], " or ", years[2])
} else if (length(years) > 1) {
years_list <- split(years, cumsum(c(1, diff(years) != 1)))
if (length(years_list) == 1) {
year_message <- paste0(years[1], " through ", years[length(years)])
} else {
years_vec <- years[1:length(years)-1]
years_vec <- paste(years_vec, collapse = ", ")
year_message <- paste0(years_vec, ", or ", years[length(years)])
}
}
# counties
names_clean <- find_counties(counties, return = "names")
if (length(names_clean) == 1) {
county_message <- paste0(names_clean, " county.")
} else if (length(names_clean) == 2) {
county_message <- paste0(names_clean[1], " or ", names_clean[2],
" county.")
} else if (length(names_clean) > 2) {
counties_vec <- names_clean[1:length(names_clean)-1]
counties_vec <- paste(counties_vec, collapse = ", ")
county_message <- paste0(counties_vec, ", or ",
names_clean[length(names_clean)], " county.")
}
stop(paste0("There weren't any pesticides containing ", chem_message,
" applied in ", year_message, " in ", county_message))
}
} else {
if (is.character(years)) {
if (years == "all") {
years <- 1990:2015
}
}
chem_df <- purexposure::chemical_list
out_chem_list <- list()
for (i in 1:length(years)) {
chem_year <- chem_df[[as.character(years[i])]]
chem_year <- chem_year %>% dplyr::mutate(year = as.character(years[i]))
out_chem_list[[i]] <- chem_year
}
out_chem_df <- dplyr::bind_rows(out_chem_list)
df <- df %>% dplyr::mutate(applic_dt = lubridate::ymd(applic_dt),
year = lubridate::year(applic_dt),
year = as.character(year)) %>%
dplyr::left_join(out_chem_df, by = c("chem_code", "year"))
}
chemicals <- "all"
if (!"all" %in% chemicals) {
years_chemicals <- expand.grid(year = years, chemicals = chemicals) %>%
dplyr::group_by(year) %>%
tidyr::nest() %>%
dplyr::mutate(chemicals = purrr::map(data, tibble_to_vector))
chem_df <- purrr::map2_dfr(years_chemicals$year, years_chemicals$chemicals,
find_chemical_codes) %>% unique()
df <- df %>%
dplyr::filter(chem_code %in% chem_df$chem_code) %>%
dplyr::left_join(chem_df, by = "chem_code") %>%
dplyr::select(-chemical) %>%
dplyr::mutate(applic_dt = lubridate::ymd(applic_dt))
# chemicals
if (nrow(df) == 0) {
if (length(chemicals) == 1) {
chem_message <- paste0(chemicals)
} else if (length(chemicals) == 2) {
chem_message <- paste0(chemicals[1], " or ", chemicals[2])
} else if (length(chemicals) > 2 & length(chemicals) < 11) {
chems_vec <- chemicals[1:length(chemicals)-1]
chems_vec <- paste(chems_vec, collapse = ", ")
chem_message <- paste0(chems_vec, ", or ", chemicals[length(chemicals)])
} else if (length(chemicals) >= 11) {
chem_message <- "these chemicals"
}
# years
if (length(years) == 1) {
year_message <- years
} else if (length(years) == 2) {
year_message <- paste0(years[1], " or ", years[2])
} else if (length(years) > 1) {
years_list <- split(years, cumsum(c(1, diff(years) != 1)))
if (length(years_list) == 1) {
year_message <- paste0(years[1], " through ", years[length(years)])
} else {
years_vec <- years[1:length(years)-1]
years_vec <- paste(years_vec, collapse = ", ")
year_message <- paste0(years_vec, ", or ", years[length(years)])
}
}
# counties
names_clean <- find_counties(counties, return = "names")
if (length(names_clean) == 1) {
county_message <- paste0(names_clean, " county.")
} else if (length(names_clean) == 2) {
county_message <- paste0(names_clean[1], " or ", names_clean[2],
" county.")
} else if (length(names_clean) > 2) {
counties_vec <- names_clean[1:length(names_clean)-1]
counties_vec <- paste(counties_vec, collapse = ", ")
county_message <- paste0(counties_vec, ", or ",
names_clean[length(names_clean)], " county.")
}
stop(paste0("There weren't any pesticides containing ", chem_message,
" applied in ", year_message, " in ", county_message))
}
} else {
if (is.character(years)) {
if (years == "all") {
years <- 1990:2015
}
}
chem_df <- purexposure::chemical_list
out_chem_list <- list()
for (i in 1:length(years)) {
chem_year <- chem_df[[as.character(years[i])]]
chem_year <- chem_year %>% dplyr::mutate(year = as.character(years[i]))
out_chem_list[[i]] <- chem_year
}
out_chem_df <- dplyr::bind_rows(out_chem_list)
df <- df %>% dplyr::mutate(applic_dt = lubridate::ymd(applic_dt),
year = lubridate::year(applic_dt),
year = as.character(year)) %>%
dplyr::left_join(out_chem_df, by = c("chem_code", "year"))
}
df
df <- df %>% dplyr::mutate(year = as.character(lubridate::year(applic_dt)))
df2 <- calc_max %>%
dplyr::select(chem_code, year, calc_max) %>%
dplyr::right_join(df, by = c("chem_code", "year")) %>%
dplyr::mutate(outlier = ifelse((!is.na(calc_max) &
lbs_per_acre > calc_max), TRUE, FALSE),
lbs_chm_used = ifelse(lbs_per_acre > calc_max,
calc_max*acre_treated, lbs_chm_used)) %>%
dplyr::rename(county_code = county_cd) %>%
dplyr::ungroup()
county <- purexposure::county_codes
out <- county %>%
dplyr::right_join(df2, by = "county_code") %>%
dplyr::mutate(use_no = paste0(use_no, "_", lubridate::year(applic_dt)),
kg_chm_used = lbs_chm_used/2.20562) %>%
dplyr::select(chem_code, chemname, kg_chm_used, MTRS, MTR, county_name,
county_code, applic_dt, aer_gnd_ind, use_no, outlier, prodno) %>%
dplyr::rename(section = MTRS,
township = MTR,
date = applic_dt,
aerial_ground = aer_gnd_ind) %>%
dplyr::arrange(date, county_name)
missing_sections <- c(grep("\\?", out$section, value = TRUE),
grep("000000000", out$section, value = TRUE))
missing_townships <- c(grep("\\?", out$township, value = TRUE),
grep("0000000", out$township, value = TRUE))
if (length(missing_sections) != 0) {
out <- out %>% dplyr::mutate(section = ifelse(section %in% missing_sections,
NA, section),
section = ifelse(section == "000000000",
NA, section))
}
if (length(missing_townships) != 0) {
out <- out %>% dplyr::mutate(township = ifelse(township %in% missing_sections,
NA, township),
township = ifelse(township == "000000",
NA, township))
}
sum_application
section_townships <- out %>%
dplyr::select(section, township) %>%
unique()
section_townships
aerial_ground
out2 <- help_sum_application(out, "all", "township", FALSE,
section_townships,
chem_code,
chemname, township, county_name, county_code,
date)
warnings()
out2
out2 %>% arrange(date)
library(dplyr)
out2 %>% arrange(date)
out2 %>% arrange(township)
out2 %>% arrange(township)
df <- out
sum <- "all"
unit <- "township"
aerial_ground <- FALSE
section_townships
chemical_class <- NULL
out2 <- help_sum_application(out, "all", "township", FALSE,
section_townships, chemical_class = NULL,
chem_code,
chemname, township, county_name, county_code,
date)
out2 %>% arrange(township)
group_by_vars <- rlang::quos(chem_code,
chemname, township, county_name, county_code,
date)
sum == "chemical_class"
df <- df %>%
dplyr::group_by(!!!group_by_vars) %>%
dplyr::summarise(kg_chm_used = sum(kg_chm_used, na.rm = TRUE)) %>%
dplyr::ungroup()
df
df %>% arrange(township)
all_cols <- c("chem_code", "chemname", "chemical_class", "kg_chm_used",
"section", "township", "county_name", "county_code",
"date", "aerial_ground", "use_no", "outlier")
missing <- all_cols[!all_cols %in% colnames(df)]
for (i in 1:length(missing)) {
new_col <- rlang::quo_name(missing[i])
df <- df %>% dplyr::mutate(!!new_col := NA)
}
df <- df %>%
dplyr::arrange(date, county_name, county_code, chemical_class, chemname,
chem_code, section, township) %>%
dplyr::select(chem_code, chemname, chemical_class, kg_chm_used,
section, township, county_name, county_code,
date, aerial_ground, use_no, outlier)
cols_to_remove <- purrr::map_dfr(colnames(df), help_remove_cols, df = df) %>%
dplyr::filter(all_missing == T) %>%
dplyr::select(col) %>%
tibble_to_vector()
cols_to_keep <- colnames(df)[!colnames(df) %in% cols_to_remove]
cols_names <- unlist(purrr::map(cols_to_keep, rlang::quo_name))
df <- df %>% dplyr::select(!!cols_names)
df
df %>% arrange(township)
colnames(df)
?calculate_exposure
