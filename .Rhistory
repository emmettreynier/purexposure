buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
} else if (chemicals == "chemical_class") { #chemical_class
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
}
row_out
exp
nested_df <- list(row_out = row_out, meta_data = list(exp))
attr(nested_df, "row.names") <- as.integer(1)
class(nested_df) <- c("tbl_df", "data.frame")
time_df$start_date
time_df$end_date
out <- purrr::map2_dfr(time_df$start_date, time_df$end_date,
calculate_exposure_bydate)
calculate_exposure_bydate <- function(start_date, end_date) {
if (chemicals == "all") { #all
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemicals,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(township = MTRS) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemicals,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
} else if (chemicals != "all" & chemicals != "chemical_class") { #AI
year <- lubridate::year(min(clean_pur_df$date))
chemical_clean <- find_chemical_codes(year, chemicals)$chemname
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date,
chemname == chemical_clean) %>%
dplyr::group_by(section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date,
chemname == chemical_clean) %>%
dplyr::group_by(township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
} else if (chemicals == "chemical_class") { #chemical_class
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
}
nested_df <- list(row_out = row_out, meta_data = list(exp))
attr(nested_df, "row.names") <- as.integer(1)
class(nested_df) <- c("tbl_df", "data.frame")
return(nested_df)
}
out <- purrr::map2_dfr(time_df$start_date, time_df$end_date,
calculate_exposure_bydate)
out <- purrr::map2(time_df$start_date, time_df$end_date,
calculate_exposure_bydate)
out
unlist(out)
out
out[[2]]$row_out
length(out)
for (i in 1:length(out)) {
exp_row <- out[[i]]$row_out
if (i == 1) {
row_out <- exp_row
} else {
row_out <- rbind(row_out, exp_row)
}
}
row_out
i <- 1
out[[i]]$meta_data
i <- 2
out[[i]]$meta_data[[1]]
nested_df
class(df)
row_out
exp
start_date
end_date
pur_filt
if (chemicals == "all") { #all
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemicals,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(township = MTRS) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemicals,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
} else if (chemicals != "all" & chemicals != "chemical_class") { #AI
year <- lubridate::year(min(clean_pur_df$date))
chemical_clean <- find_chemical_codes(year, chemicals)$chemname
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date,
chemname == chemical_clean) %>%
dplyr::group_by(section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date,
chemname == chemical_clean) %>%
dplyr::group_by(township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
} else if (chemicals == "chemical_class") { #chemical_class
if ("section" %in% colnames(pur_filt)) {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, section) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTRS = as.character(MTRS)) %>%
dplyr::rename(section = MTRS) %>%
dplyr::left_join(pur_out, by = "section") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, section, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
} else {
pur_out <- pur_filt %>%
dplyr::filter(date >= start_date & date <= end_date) %>%
dplyr::group_by(chemical_class, township) %>%
dplyr::summarise(kg = sum(kg_chm_used)) %>%
dplyr::ungroup()
buffer_area <- pi * (radius^2)
exp <- out %>%
dplyr::mutate(MTR = as.character(MTR)) %>%
dplyr::rename(township = MTR) %>%
dplyr::left_join(pur_out, by = "township") %>%
dplyr::mutate(kg_int = percent * kg,
location = location,
radius = radius,
start_date = start_date,
end_date = end_date,
chemicals = chemical_clean,
area = buffer_area,
none_recorded = FALSE) %>%
dplyr::select(location, township, percent, kg, kg_int,
start_date, end_date, radius, chemicals, area,
none_recorded)
exp_out <- exp %>% dplyr::summarise(exposure =
sum(kg_int, na.rm = TRUE) /
buffer_area)
row_out <- data.frame(exposure = exp_out, location = location,
start_date = start_date,  end_date = end_date,
radius = radius, chemicals = chemicals,
none_recorded = FALSE)
}
}
exp
row_out
=row_out[1,]
row_out[1,]
row_out <- row_out[1,]
list(row_out = row_out, meta_data = exp)
attr(nested_df, "row.names") <- as.integer(1)
class(nested_df) <- c("tbl_df", "data.frame")
nested_df
?calculate_exposure
library(purexposure)
devtools::document()
?calculate_exposure
