---
title: "Using the `purexposure` package"
author: "Rachel Severson"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(purexposure)
library(dplyr)
```
```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  error = TRUE
)
```

The California Department of Pesticide Regulation publishes free copies of Pesticide Use Reports online through the California Pesticide Information Portal ([CalPIP](http://calpip.cdpr.ca.gov/main.cfm)). The `purexposure` package makes it easy to download Pesticide Use Report (PUR) raw data, output reports in a tidy format, calculate exposure to applied pesticides, and visualize application for counties or more specific locations. 

The `purexposure` package has four main categories of functions: `find_*`, `pull_*`, `calculate_*`, and `plot_*`. `find_*` functions are designed to explore both pesticide products and active ingredients present in applied pesticides, return county names or codes as they are used in PUR datasets, and find the county of a particular location. `pull_*` functions pull raw or cleaned PUR datasets through the CA Department of Pesticide Regulation's FTP server. The `calculate_exposure` function calculates exposure to applied pesticides for a given location, and `plot_*` functions return visualizations of application and exposure.  

`purexposure` currently exists in a development version on GitHub. You can install and load the package with the following code: 

```{r eval = FALSE}
devtools::install_github("leighseverson/purexposure")
library(purexposure)
```

## Overview of PUR datasets 

### Units of application 

Pesticide applications are reported on a product basis, but are recorded by the California Department of Pesticide Regulation (CDPR) by active ingredient. There are usually several active ingredients contained in a single product, so a single pesticide product application is represented by several rows in a dataset. In PUR datasets, the `prodno` and `chem_code`/`chemname` variables indicate product names and active ingredient codes/names, respectively. 

### Time

Records for the amount of active ingredient applied are reliably recorded by day. Raw PUR datasets have a variable called `applic_time`, the time that the pesticide product application was completed; however, application time is only required for production agricultural reports and was not added to PUR datasets until 1999. Application time is therefore often missing in raw PUR datasets, and is not retained in datasets cleaned using this package. 

PUR datasets can be pulled by years in the range [1990, 2015]. 

### Geography  

PUR datasets are organized and pulled by county. Application is recorded by township and section, which are units of land resulting from the Public Land Survey System (PLSS). The PLSS is used to subdivide and describe land in the United States, and is regulated by the Bureau of Land Management. Most midwestern, some southern, and all western states are incuded in the PLSS. There are several initial points from which PLSS surveys begin from. The line running north-south through the initial points is called the Principle Meridian, and the east-west line running through the points is called the base line. California contains three of these initial points, and three Principle Meridians: Humboldt (H), Mount Diablo (M), and San Bernardino (S). 

```{r echo = FALSE, out.width = "250pt", out.height = "400pt", fig.cap = "Base Lines and Meridian lines in California. Source: https://www.blm.gov/cadastral/meridians/Caleneva.htm"}
knitr::include_graphics("figures/calneva.jpg")
```

Townships are six-mile-square areas that are identified by a combination of the location north or south of the base line, and range, the location east or west of the principle meridian. Townships are divided into 36 one-mile-square sections. California townships are uniquely identified by a combination of Principle Meridian (H, M, or S), location north or south of the base line (01-48), base line direction (N or S), location east or west of the Principle Meridian (01-47), and Principle Meridian direction (E or W). Sections are identified by the same combination, with the addition of the section number (01-36). For example, one township in California is identified by "M15S24E", and a section within that township is identified by "M15S24E01". The diagram below shows an example of a township (outlined in blue) and one of the 36 sections within that township (outlined in red). 

```{r echo = FALSE, fig.align = "center", out.width = "250pt", out.height = "250pt", fig.cap = "Sectional map of a township showing adjoining sections. Source: https://www.blm.gov/or/pubroom/files/land-descript-diag.pdf"}
knitr::include_graphics("figures/section_townships.png")
```

## Main functions in the `purexposure` package 

### 1. `find_*` functions: search for active ingredients, product names, and counties 

By default, the package works with all recorded active ingredients in the specified counties and date range. However, if you're interested in analyzing application of a specific active ingredient or chemcial class of active ingredients, the `find_chemical_codes` function is useful as a starting point to see what active ingredients were present in applied pesticides in a given year. 

For example, too see how active ingredients matching "methyl bromide" or "abietic" were recorded in the year 2000, we would run: 

```{r}
find_chemical_codes(year = 2000, chemicals = c("methyl bromide", "abietic"))
```

The `chem_code` column gives the PUR chemical code for the active ingredient, and `chemname` gives the PUR chemical name. `chemical` gives the search terms input in the `chemicals` argument. This function can also be useful to find the number of unqiue active ingredients that were recorded in applied pesticides in a given year: 

```{r}
find_chemical_codes(2000) %>% nrow
```

3,637 unique active ingredients were present in applied pesticides in California in the year 2000. 

The `find_chemical_codes` function works using `grep` to perform pattern matching. Therefore, it may not be effective in returning all active ingredients that should fall under your search term. To find an exhaustive list of all active ingredients that fall under a chemical class, you may find it useful to refer to the CA Department of Pesticide Regulation (DPR)'s [Summary of Pesticide Use Report Data, Indexed by Chemical (2008)](http://www.cdpr.ca.gov/docs/pur/pur08rep/chmrpt08.pdf). Chemical classes available in the Summary include:

- chemicals known to cause reproductive toxicity, 
- chemcials known to cause cancer, 
- cholinesterase-inhibiting pesticides (organophosphate and carbamate active ingredients),
- pesticides on DPR's ground water protection list,
- pesticides on DPR's toxic air contaminants list, 
- fumigant pesticides, 
- oil pesticides, and 
- biopesticides. 

You can use active ingredients listed under the relevant class to include in the `chemicals` argument of `find_chemical_codes` to find if those active ingredients were present in applied pesticides in a given year.

The `find_product_name` works similarly: you can use it to download a product table and search for applied pesticide products for a given year: 

```{r eval = FALSE, echo = 1}
product_table <- find_product_name(2015, "insecticide")
save(product_table, file = "data/product_table.RData")
```
```{r echo = FALSE}
load("data/product_table.RData")
```
```{r}
head(product_table, 3)
```

The `prodno` column in the product table can be matched with the same column in a PUR dataset. 

Counties are indicated in raw PUR datasets by `county_cd`: a two-digit integer code. While you can pull data for for counties with either their name or PUR code, the `find_counties` function could be useful to find the code or name associated with a county. 

```{r}
find_counties(c("01", "02", "03"), return = "names")
```

Additionally, the `county_codes` dataset included with this package lists all 58 counties in California with names and codes as they are recorded in PUR datasets: 

```{r}
purexposure::county_codes %>% slice(1:3)
```

The `find_location_county` function takes a California address or coordinate pair (longitude, latitude) and returns the county of that location. This function is useful later on if you want to pull PUR data to calculate exposure at a particular location. 

### 2. `pull_*` functions: pull raw or cleaned PUR datasets

#### Raw data 

The `pull_raw_pur` function pulls raw PUR data from CDPR's [FTP server](ftp://transfer.cdpr.ca.gov/pub/outgoing/pur_archives/): 

```{r eval = FALSE, echo = 1}
fresno_raw <- pull_raw_pur(years = 2004, counties = "fresno")
fresno_raw <- fresno_raw[1:2,]
save(fresno_raw, file = "data/fresno_raw.RData")
```
```{r echo = FALSE}
load("data/fresno_raw.RData")
```
```{r}
head(fresno_raw, 2)
```

Raw data pulled using `pull_raw_pur` may differ from datasets downloaded manually from CDPR's FTP server in a few ways: 

1. Number of columns: The data pulled using `pull_raw_pur` always has 33 columns. The datasets for some years and counties included columns called `error_flag` and `comtrs`. Since these variables are inconsistently present and are not documented in the User Guide & Documentation manual, they were removed. 
2. Order of rows: Datasets pulled using this package are arranged by `applic_dt` (application date) and `county_cd` (county code). This may not be the case for datasets downloaded manually. 

For documentation of raw PUR data, you can reference the Pesticide Use Report Data User Guide & Documentation document published by the CA Department of Pesticide Regulation. The file is saved as "cd_doc.pdf in any "pur[year].zip" file between 1990 and 2015 found here: ftp://transfer.cdpr.ca.gov/pub/outgoing/pur_archives/. 

#### Cleaned data 

The `pull_clean_pur` function pulls and cleans PUR data. You can similarly pull data by years and by counties, with additional arguments to specify the format and contents of your cleaned dataset. Here's what a cleaned dataset for Fresno county looks like for 2004: 

```{r eval = FALSE, echo = 1}
fresno_clean <- pull_clean_pur(2004, "fresno")
fresno_clean <- fresno_clean[1:2,]
save(fresno_clean, file = "data/fresno_clean.RData")
```
```{r echo = FALSE}
load("data/fresno_clean.RData")
```
```{r}
head(fresno_clean, 2)
```

Pesticide application is recorded by active ingredient (`chem_code` and `chemname`), kilograms of active ingredient applied (`kg_chm_used`), section, township, county (`county_code` and `county_name`), date, method of application (`aerial_ground`) and product number (`prodno`). Raw PUR datasets are recorded in units of pounds, and cleaned datasets convert applied pesticides to units of kilograms by dividing pounds of active ingredient applied by 2.20562. The `use_no` variable uniquely identifies pesticide product uses across years. 

**Outliers**

The `outlier` column is a logical value indicating whether the record has been flagged as an outlier, in which case `kg_chm_used` has been replaced with a calculated maximum rate of application. The algorithm used to identify and correct erroneously high records of application were developed based on methods used by @Gunier2001. 

For each active ingredient and each year, a calculated maximum rate of application was calculated as mean pounds per acre plus two standard deviations. Rates were calculated from pounds applied by dividing the raw `lbs_chm_used` column by either the `acre_treated` column as is for `unit_treated == "A"` (acres), or by the `acre_treated` column multiplied by $\scriptsize2.29568\times10^{-5}$ for `unit_treated == "S"` (square feet). 

If the pounds per acre applied on a particular day exceeded the calculated maximum rate of application for the relevant year and active ingredient, the recorded rate was replaced with the calculated maximum rate, and the `outlier` column was set to `TRUE`. This calculated maximum rate of pounds per acre was then converted back to pounds of chemical applied by multiplying the rate by the number of acres treated, before being converted to kilograms of chemical applied. 

**Table format** 

By default, application records are organized by active ingredient, section, township, date, and application method. You can change the format of the cleaned data with additional arguments to `pull_clean_pur`. 

The `chemicals` argument uses the `find_chemical_code` function to filter by the `chemname` column. You can filter by listing search terms in the `chemicals` argument: 

```{r echo = 1, eval = FALSE}
nevada_sulfur <- pull_clean_pur(years = 2000, counties = c("nevada"), chemicals = "sulfur")
nevada_sulfur <- nevada_sulfur[1:2,]
save(nevada_sulfur, file = "data/nevada_sulfur.RData")
```
```{r echo = FALSE}
load("data/nevada_sulfur.RData")
```
```{r}
head(nevada_sulfur, 2)
unique(nevada_sulfur$chemname)
```

There are several records for active ingredients matching the search term `methylene` for 2003 that were applied across California in 2000 (`find_chemical_codes(2000, "sulfur")`); however, only two of these were applied in Nevada county in 2000. If you're using the `chemicals` argument to filter a PUR dataset, you may want to do additional filtering (for example, if you were only interested "sulfur" active ingredients and not "lime-sulfur").

Application method (`aerial_ground`), which indicates if pesticides were applied aerially (`A`), by ground (`B`) or with another method (`O`), can be retained or discarded with the `aerial_ground` argument set to `TRUE` or `FALSE`. This choice becomes more important when summing applied active ingredients and calculating exposure; both situations are discussed further down. 

By default, cleaned PUR datasets often have many records per day. There are a few different options for how to sum application so that there is one record per active ingredient or chemical class, PLS unit (section or township), and potentially per method of application (aerial, ground, or other). The `sum_application`, `unit`, `sum`, `aerial_ground`, and `chemical_class` arguments are all relevant here. 

When `sum_application` is set to `TRUE`, the `unit` argument indicates what Public Land Survey (PLS) unit you would like to sum application by (`"section"`, the default, or `"township"`). If `aerial_ground` is set to `TRUE`, records will be summed by each method of application as well. The `sum` argument can be set to `"all"`, the default, or `"chemical_class"`. `"all"` indicates that you would like to sum all active ingredients present in the dataset (which could be filtered using the `chemicals` argument) to give a daily value of kilograms of pesticides applied per PLS unit. For example, we can pull data for 2010 in Tulare county, summed by active ingredient and township: 

```{r eval = FALSE, echo = 1:3}
tulare <- pull_clean_pur(2010, "tulare", 
                         sum_application = TRUE, 
                         unit = "township", 
                         aerial_ground = FALSE)
tulare <- tulare %>% arrange(township) %>% slice(1:3)
save(tulare, file = "data/tulare.RData")
```
```{r echo = FALSE}
load("data/tulare.RData")
```
```{r}
tulare %>% arrange(township) %>% slice(1:3)
```

There is one record per active ingredient per township per day. Alternatively, `sum = "chemical_class"` indicates that you would like to group certain active ingredients together to give a daily value for each chemical class that those active ingredients fall into. If `sum = "chemical_class"`, the active ingredients that belong to each class are specified with the `chemical_class` argument, which takes a data frame with three columns: `chem_code`, `chem_name`, and `chemical_class`. For example, a data frame input to the `chemical_class` argument might look like this: 

```{r}
chemical_class_df <- rbind(find_chemical_codes(2000, "methylene"),
                           find_chemical_codes(2000, "aldehyde")) %>%
  dplyr::rename(chemical_class = chemical)
head(chemical_class_df, 2)
tail(chemical_class_df, 2)
```

You may need to do some additional filtering if the results returned by `find_chemical_codes` (which relies on "grep" for pattern matching) do not give the appropriate active ingredients for your chemical class of interest. In the case of the `chemical_class` data frame above, there would be at most three summed values per day and per PLS unit, one for all active ingredients falling under the class "methylene", one for all active ingredients falling under the class "aldehyde", and one for "other" with all active ingredients that don't fit into the two specified classes.  

```{r eval = FALSE, echo = 1:4}
fresno_classes <- pull_clean_pur(2008, "fresno", sum_application = TRUE, 
                                 unit = "section", sum = "chemical_class", 
                                 chemical_class = chemical_class_df, 
                                 aerial_ground = FALSE)
unique_classes <- unique(fresno_classes$chemical_class)
save(unique_classes, file = "data/unique_classes.RData")
fresno_classes <- fresno_classes[1:3, ]
save(fresno_classes, file = "data/fresno_classes.RData")
```
```{r echo = FALSE}
load("data/unique_classes.RData")
load("data/fresno_classes.RData")
```
```{r}
head(fresno_classes, 3)
```
```{r eval = FALSE}
unique(fresno_classes$chemical_class)
```
```{r echo = FALSE}
unique_classes
```

By default, `pull_clean_pur` will print a downloading progress bar for each year of data that you are pulling. You can turn this off by setting the `download_progress` argument to `FALSE`. 

If you've already pulled data using `pull_raw_pur`, you can clean the data without having to pull it again by inputing the raw data frame to the `raw_pur_df` argument. In this case, the `years` and `counties` argument should be present in the raw data frame. 

```{r eval = FALSE}
fresno_clean <- pull_clean_pur(2004, "fresno", raw_pur_df = fresno_raw)
```

### `calculate_exposure` to applied pesticides 

The `calculate_exposure` function calculates exposure to applied pesticides at a particular location for a given buffer extending from the location, time period, and group of active ingredients. The required arguments are `clean_pur_df`, a data frame returned from `pull_clean_pur`, `location`, which can be an address or a coordinate pair, and radius, which gives the radius of the buffer extending from the location in meters. 

Exposure is calculated by summing the amount of applied pesticides in the fraction of sections or townships that are overlapped by the buffer described by `radius`. For example, if a radius covers 50% of section A, 25% of section B, 25% of section C, and 30% of section D, the pesticides applied in those section are multiplied by 0.5, 0.25, 0.25, and 0.3, respectively. The time period over which application is summed is determined by the `time_period` argument. If `time_period` is `NULL`, application is summed over the date range of the `clean_pur_df` dataset. `time_period` takes strings of units of time (`"2 weeks"` or `"6 months"`, for example) and calculates exposure separately using that unit of time as a break point. The first time period will always begin on the first day of the year. If the `clean_pur_df` dataset has data from February through August, for example, and `time_period` is set to `"6 months"`, exposure will be calculated separately for January through June and July through December. 

If the input `clean_pur_df` data frame has a `chemical_class` column and the `chemicals` argument in `calculate_exposure` is set to `"chemical_class"`, 



For example, to calculate exposure at Sun Empire Elementary for the year 2015: 

```{r}
sun_empire <- pull_clean_pur(2015, "fresno") %>% 
  calculate_exposure(location = "2649 North Modoc Ave., Kerman, CA", 
                     radius = 1500) 
```




takes advantage of the reporting structure of PUR datasets to calculate exposure based on the amount of pesticides applied in PLS units overlapping with a buffer that extends from 

- use one of the example datasets from above 
- go through each element of the returned list 
- only run once (run for all, and for a time period (this is optional), but explain that you could run for chemical classes as well.)

### `plot_*` functions: visualize application of and exposure to applied pesticides 

- map_ functions: related to county plots, PLS units 
- plot_ functions: timeseries (application and exposure) 
-- exposure timeseries..... relevant if you've calculated exposure for several locations or 
for one location over a long period of time. This will take a while to run. Make sure to 
code this so geocoding isn't running several times for the same location. 

### Using `purexposure` to calculate exposure to multiple locations 

## References









